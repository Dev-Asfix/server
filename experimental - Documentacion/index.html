<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tacho Inteligente - Avanzado</title>
    <!-- Enlace al archivo de estilo CSS -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">

      <!-- Sección Izquierda: Monitoreo del Tacho -->
      <div class="left-section">
        <h2>Monitoreo del Tacho</h2>
        
        <!-- Representación visual del tacho de basura -->
        <div class="tacho">
          <!-- El div 'nivel' mostrará el nivel de llenado del tacho dinámicamente -->
          <div id="nivel" class="nivel"></div>
        </div>

        <!-- Información sobre el estado, distancia, fecha y alertas -->
        <div class="info">
          <p id="estado">Estado: --</p>
          <p id="distancia">Distancia: -- cm</p>
          <p id="fecha">Fecha y Hora: --</p>
          <p id="alerta" class="alerta"></p>
        </div>
      </div>

      <!-- Sección Derecha: Análisis del llenado -->
      <div class="right-section">
        <h2>Tiempo promedio de llenado</h2>
        <div class="analysis">
          <!-- Muestra el tiempo promedio de llenado calculado -->
          <p id="averageFillTime">Promedio: -- segundos</p>
          <!-- Predicción de cuándo se llenará el tacho -->
          <p id="prediccionLlenado">Predicción de llenado: --</p>
          <!-- Recomendaciones basadas en los datos de llenado -->
          <p id="mensajeRecomendacion">Recomendación: --</p>
        </div>
      </div>

      <!-- Sección Tabla: Duración de los diferentes estados del tacho -->
      <div class="table-section">
        <h2>Duración de los estados</h2>
        <div class="tablita">
          <table>
            <thead>
              <tr>
                <!-- Encabezados de la tabla -->
                <th>Estado</th>
                <th>Fecha</th>
                <th>Duración</th>
              </tr>
            </thead>
            <!-- Cuerpo de la tabla que se actualizará dinámicamente -->
            <tbody id="estadoTable"></tbody>
          </table>
        </div>
        
      </div>

    </div>

    <!-- JavaScript para manejar la lógica del tacho inteligente -->
    <script>
      const ws = new WebSocket('ws://localhost:3000'); // Establece una conexión WebSocket con el servidor
      let estadoActual = ''; // Almacena el estado actual del tacho
      let inicioEstado; // Almacena el tiempo de inicio del estado actual
      let tiemposEstados = []; // Almacena las duraciones de los diferentes estados

      // Evento que se dispara cuando se recibe un mensaje del servidor
      ws.onmessage = (event) => {
        const data = JSON.parse(event.data); // Convierte los datos recibidos a formato JSON
        // Actualiza la interfaz con los datos recibidos
        document.getElementById('estado').innerText = `Estado: ${data.estado}`;
        document.getElementById('distancia').innerText = `Distancia: ${data.distancia} cm`;
        document.getElementById('fecha').innerText = `Fecha y Hora: ${data.timestamp}`;
        document.getElementById('averageFillTime').innerText = `Promedio: ${data.averageFillTime || '--'} segundos`;

        // Si hay una alerta, se muestra en pantalla
        if (data.alert) {
          document.getElementById('alerta').innerText = data.alert;
        }

        // Llama a funciones para actualizar la vista y realizar cálculos
        actualizarTacho(data.estado);
        registrarEstado(data.estado, data.timestamp);
        calcularPromedioLlenado();
        hacerPrediccionLlenado(data.estado, data.distancia);
        mostrarRecomendacion(data.averageFillTime);
      };

      // Función para actualizar el nivel visual del tacho según el estado
      function actualizarTacho(estado) {
        const nivel = document.getElementById('nivel');
        let porcentaje = 0;
        // Define el porcentaje de llenado en función del estado recibido
        switch (estado) {
          case 'Vacio':
            porcentaje = 0;
            break;
          case 'Bajo':
            porcentaje = 25;
            break;
          case 'Medio':
            porcentaje = 50;
            break;
          case 'Alto':
            porcentaje = 75;
            break;
          case 'Lleno':
            porcentaje = 100;
            break;
        }
        nivel.style.height = `${porcentaje}%`; // Ajusta la altura del div "nivel" para representar el porcentaje
      }

      // Función para registrar el estado y calcular la duración de cada estado
      function registrarEstado(estado, timestamp) {
        if (estado !== estadoActual) { // Solo registra si hay un cambio de estado
          const finEstado = new Date(); // Marca el tiempo de fin del estado anterior
          if (estadoActual !== '') { // Si hay un estado anterior, calcula su duración
            const duracion = (finEstado - inicioEstado) / 1000; // Duración en segundos
            // Añade una fila a la tabla con el estado, fecha y duración
            const row = `<tr><td>${estadoActual}</td><td>${timestamp}</td><td>${duracion.toFixed(2)} s</td></tr>`;
            document.getElementById('estadoTable').innerHTML += row;
            tiemposEstados.push({ estado: estadoActual, duracion: duracion }); // Guarda la duración en el array
          }
          estadoActual = estado; // Actualiza el estado actual
          inicioEstado = new Date(); // Marca el inicio del nuevo estado
        }
      }

      // Función para calcular el promedio de llenado del tacho
      function calcularPromedioLlenado() {
        if (tiemposEstados.length === 0) return; // Si no hay estados registrados, no hace nada

        // Filtra los estados y toma solo las duraciones de estados que no sean 'Vacio' ni 'Lleno'
        const duraciones = tiemposEstados.filter(te => te.estado !== 'Vacio' && te.estado !== 'Lleno')
                                         .map(te => te.duracion);
        if (duraciones.length === 0) return;

        // Calcula el promedio de las duraciones
        const promedio = duraciones.reduce((a, b) => a + b, 0) / duraciones.length;
        // Muestra el promedio en la interfaz
        document.getElementById('averageFillTime').innerText = `Promedio: ${promedio.toFixed(2)} segundos`;
      }

      // Función para hacer una predicción del tiempo de llenado del tacho
      function hacerPrediccionLlenado(estado, distancia) {
        let mensaje = '';
        // Define el mensaje según el estado actual del tacho
        switch (estado) {
          case 'Vacio':
            mensaje = 'El tacho está vacío. Asegúrate de llenarlo pronto.';
            break;
          case 'Bajo':
            mensaje = 'El tacho está bajo. Requiere llenado pronto.';
            break;
          case 'Medio':
            mensaje = 'El tacho está medio lleno. Mantén el control.';
            break;
          case 'Alto':
            mensaje = 'El tacho está casi lleno. Revisa pronto.';
            break;
          case 'Lleno':
            mensaje = 'El tacho está lleno. Debe vaciarse.';
            break;
        }
        
        // Calcula el tiempo estimado para que el tacho se llene por completo
        const tiempoLlenado = calcularTiempoLlenado(distancia);
        if (tiempoLlenado) {
          mensaje += ` Tiempo estimado para llenarse: ${tiempoLlenado} segundos.`;
        }

        // Muestra el mensaje de predicción en la interfaz
        document.getElementById('prediccionLlenado').innerText = mensaje;
      }

      // Función para calcular el tiempo estimado de llenado en función de la distancia
      function calcularTiempoLlenado(distancia) {
        const umbral = 3; // Distancia mínima para considerarlo lleno
        const tasaCambio = 5; // Tasa de cambio de nivel por segundo (ejemplo)
        if (distancia < umbral) return 'Inminente'; // Si está casi lleno, retorna 'Inminente'
        return ((distancia - umbral) / tasaCambio).toFixed(2); // Calcula el tiempo restante
      }

      // Función para mostrar recomendaciones en función del tiempo promedio de llenado
      function mostrarRecomendacion(promedio) {
        const promedioNum = parseFloat(promedio);
        let mensaje = '';

        // Se muestra una recomendación dependiendo del promedio calculado
        if (!isNaN(promedioNum)) {
          if (promedioNum < 10) {
            mensaje = getRandomRecommendation([
              '¡El tacho se llena rápidamente! Considera programar vaciados más frecuentes.',
              'El tiempo de llenado es corto. Mantén una vigilancia constante.',
              'Revisa si el tacho necesita ser vaciado con más frecuencia.'
            ]);
          } else if (promedioNum < 20) {
            mensaje = 'El llenado está a un ritmo moderado. Puedes optimizar las frecuencias de vaciado.';
          } else {
            mensaje = 'El llenado es lento. No es urgente vaciarlo pronto.';
          }
        }

        // Muestra el mensaje en la interfaz
        document.getElementById('mensajeRecomendacion').innerText = mensaje;
      }

      // Función auxiliar para obtener una recomendación aleatoria de un array
      function getRandomRecommendation(recommendations) {
        return recommendations[Math.floor(Math.random() * recommendations.length)];
      }

    </script>
</body>
</html>
