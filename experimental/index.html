<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tacho Inteligente - Avanzado</title>
    <link rel="stylesheet" href="styles.css">
  </head>
  <body>
    <div class="container">
      
      <!-- Sección Izquierda: Tacho y Estado -->
      <div class="left-section">
        <h2>Monitoreo del Tacho</h2>
        <div class="tacho">
          <div id="nivel" class="nivel"></div>
        </div>
        <div class="info">
          <p id="estado">Estado: --</p>
          <p id="distancia">Distancia: -- cm</p>
          <p id="fecha">Fecha y Hora: --</p>
          <p id="alerta" class="alerta"></p>
        </div>
      </div>
      
      <!-- Sección Derecha: Análisis y Recomendaciones -->
      <div class="right-section">
        <h2>Tiempo promedio de llenado</h2>
        <div class="analysis">
          <p id="averageFillTime">Promedio: -- segundos</p>
          <p id="prediccionLlenado">Predicción de llenado: --</p>
          <p id="mensajeRecomendacion">Recomendación: --</p>
        </div>
      </div>
      
      <!-- Sección Tabla: Duración de los estados -->
      <div class="table-section">
        <h2>Duración de los estados</h2>
        <table>
          <thead>
            <tr>
              <th>Estado</th>
              <th>Fecha</th>
              <th>Duración</th>
            </tr>
          </thead>
          <tbody id="estadoTable"></tbody>
        </table>
      </div>
  
    </div>

  <script>
    const ws = new WebSocket('ws://localhost:3000');
    let estadoActual = '';
    let inicioEstado;
    let tiemposEstados = [];

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      document.getElementById('estado').innerText = `Estado: ${data.estado}`;
      document.getElementById('distancia').innerText = `Distancia: ${data.distancia} cm`;
      document.getElementById('fecha').innerText = `Fecha y Hora: ${data.timestamp}`;
      document.getElementById('averageFillTime').innerText = `Promedio: ${data.averageFillTime || '--'} segundos`;

      if (data.alert) {
        document.getElementById('alerta').innerText = data.alert;
      }

      actualizarTacho(data.estado);
      registrarEstado(data.estado, data.timestamp);
      calcularPromedioLlenado();
      hacerPrediccionLlenado(data.estado, data.distancia);
      mostrarRecomendacion(data.averageFillTime);
    };

    function actualizarTacho(estado) {
      const nivel = document.getElementById('nivel');
      let porcentaje = 0;
      switch (estado) {
        case 'Vacio':
          porcentaje = 0;
          break;
        case 'Bajo':
          porcentaje = 25;
          break;
        case 'Medio':
          porcentaje = 50;
          break;
        case 'Alto':
          porcentaje = 75;
          break;
        case 'Lleno':
          porcentaje = 100;
          break;
      }
      nivel.style.height = `${porcentaje}%`;
    }

    function registrarEstado(estado, timestamp) {
      if (estado !== estadoActual) {
        const finEstado = new Date();
        if (estadoActual !== '') {
          const duracion = (finEstado - inicioEstado) / 1000;
          const row = `<tr><td>${estadoActual}</td><td>${timestamp}</td><td>${duracion.toFixed(2)} s</td></tr>`;
          document.getElementById('estadoTable').innerHTML += row;
          tiemposEstados.push({ estado: estadoActual, duracion: duracion });
        }
        estadoActual = estado;
        inicioEstado = new Date();
      }
    }

    function calcularPromedioLlenado() {
      if (tiemposEstados.length === 0) return;

      const duraciones = tiemposEstados.filter(te => te.estado !== 'Vacio' && te.estado !== 'Lleno')
                                        .map(te => te.duracion);
      if (duraciones.length === 0) return;

      const promedio = duraciones.reduce((a, b) => a + b, 0) / duraciones.length;
      document.getElementById('averageFillTime').innerText = `Promedio: ${promedio.toFixed(2)} segundos`;
    }

    function hacerPrediccionLlenado(estado, distancia) {
      let mensaje = '';
      switch (estado) {
        case 'Vacio':
          mensaje = 'El tacho está vacío. Asegúrate de llenarlo pronto.';
          break;
        case 'Bajo':
          mensaje = 'El tacho está bajo. Requiere llenado pronto.';
          break;
        case 'Medio':
          mensaje = 'El tacho está medio lleno. Mantén el control.';
          break;
        case 'Alto':
          mensaje = 'El tacho está casi lleno. Revisa pronto.';
          break;
        case 'Lleno':
          mensaje = 'El tacho está lleno. Debe vaciarse.';
          break;
      }
      
      const tiempoLlenado = calcularTiempoLlenado(distancia);
      if (tiempoLlenado) {
        mensaje += ` Tiempo estimado para llenarse: ${tiempoLlenado} segundos.`;
      }

      document.getElementById('prediccionLlenado').innerText = mensaje;
    }

    function calcularTiempoLlenado(distancia) {
      const umbral = 3; // Distancia mínima para considerarlo lleno
      const tasaCambio = 5; // Ejemplo de tasa de cambio de nivel por segundo
      if (distancia < umbral) return 'Inminente'; // Relleno en curso
      return ((distancia - umbral) / tasaCambio).toFixed(2);
    }

    function mostrarRecomendacion(promedio) {
      const promedioNum = parseFloat(promedio);
      let mensaje = '';

      if (!isNaN(promedioNum)) {
        if (promedioNum < 10) {
          mensaje = getRandomRecommendation([
            '¡El tacho se llena rápidamente! Considera programar vaciados más frecuentes.',
            'El tiempo de llenado es corto. Mantén una vigilancia constante.',
            '¡Atención! El tacho se llena en poco tiempo. Planifica con anticipación.'
          ]);
        } else if (promedioNum < 20) {
          mensaje = getRandomRecommendation([
            'El tacho tiene un tiempo de llenado moderado. Ajusta tu planificación según sea necesario.',
            'Tiempo de llenado aceptable. Considera el monitoreo periódico.',
            'El llenado es estable. Mantén el sistema bajo observación.'
          ]);
        } else {
          mensaje = getRandomRecommendation([
            'El tiempo de llenado es largo. Podría ser una buena idea revisar el proceso de llenado.',
            '¡El tacho se llena lentamente! Revisa si hay algún problema en el sistema.',
            'Tiempo de llenado prolongado. Evalúa si es necesario ajustar el mantenimiento.'
          ]);
        }
      } else {
        mensaje = 'No hay datos suficientes para proporcionar una recomendación.';
      }

      document.getElementById('mensajeRecomendacion').innerText = mensaje;
    }

    function getRandomRecommendation(recommendations) {
      const index = Math.floor(Math.random() * recommendations.length);
      return recommendations[index];
    }
  </script>
</body>
</html>
