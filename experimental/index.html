<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tacho Inteligente - Avanzado</title>
    <link rel="stylesheet" href="styles.css">
  </head>
  <body>
<<<<<<< HEAD
    <div class="container">
      
      <!-- Sección Izquierda: Tacho y Estado -->
      <div class="left-section">
        <h2>Monitoreo del Tacho</h2>
        <div class="tacho">
          <div id="nivel" class="nivel"></div>
        </div>
        <div class="info">
          <p id="estado">Estado: --</p>
          <p id="distancia">Distancia: -- cm</p>
          <p id="fecha">Fecha y Hora: --</p>
          <p id="alerta" class="alerta"></p>
        </div>
      </div>
      
      <!-- Sección Derecha: Análisis y Recomendaciones -->
      <div class="right-section">
        <h2>Tiempo promedio de llenado</h2>
        <div class="audio-container" id="audioContainer">
          <div class="audio-icon"></div>
          <audio id="audioPlayer" controls></audio>
      </div>
        <div class="analysis">
          <p id="averageFillTime">Promedio: -- segundos</p>
          <p id="prediccionLlenado">Predicción de llenado: --</p>
          <p id="mensajeRecomendacion">Recomendación: --</p>
        </div>
      </div>
      
      <!-- Sección Tabla: Duración de los estados -->
      <div class="table-section">
        <h2>Duración de los estados</h2>
        <table>
          <thead>
            <tr>
              <th>Estado</th>
              <th>Fecha</th>
              <th>Duración</th>
            </tr>
          </thead>
          <tbody id="estadoTable"></tbody>
        </table>
      </div>
  
    </div>

  
   
=======
    
    
    <div class="container-principal">
      <div class="left-section">
        <!-- Contenido de la sección izquierda -->
        <h2>Monitoreo del Tacho</h2>
        <div class="content">
          <!-- Tacho a la izquierda -->
          <div class="tacho">
            <div id="nivel" class="nivel"></div>
          </div>
    
          <!-- Info a la derecha -->
          <div class="info">
            <p id="estado">Estado: --</p>
            <p id="distancia">Distancia: -- cm</p>
            <p id="fecha">Fecha y Hora: --</p>
            <p id="alerta" class="alerta"></p>
          </div>
        </div>
    
        <div class="audio-container" id="audioContainer">
          <div class="audio-icon"></div>
          <audio id="audioPlayer" controls></audio>
        </div>
      </div>
    
      <!-- Sección Derecha -->
      <div class="right-section">
       
        <div class="guardar">
          <button id="guardadito">ML</button>
          <div id="recommendations">
            <div class="analysis">
              <h2>Recomendaciones</h2>
              <p id="mensajeRecomendacion">Esperando datos...</p>
            </div>
          </div>
          <div id="predictions">
            <div class="analysis">
              <h2>Predicciones</h2>
              <p id="prediccionLlenado">Esperando datos...</p>
            </div>
          </div>
        </div>
        <div class="analysis">
          <p id="averageFillTime">Promedio: -- segundos</p>
        </div>
    
        <!-- Tabla -->
        <div class="table-section">
          <h2>Duración de los estados</h2>
          <table>
            <thead>
              <tr>
                <th>Estado</th>
                <th>Fecha</th>
                <th>Duración</th>
              </tr>
            </thead>
            <tbody id="estadoTable"></tbody>
          </table>
        </div>
      </div>
    </div>
    
>>>>>>> bf5751f (Version  Nueva)

  <script>
    const ws = new WebSocket('ws://localhost:3000');
    let estadoActual = '';
    let inicioEstado;
    let tiemposEstados = [];
    let audioIndex = 0;
    let audioPlaying = false;

    const audios = [
            'audios/audio1.mp3',
            'audios/audio2.mp3',
            'audios/audio3.mp3',
            'audios/audio4.mp3',
            'audios/audio5.mp3'
        ];

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      document.getElementById('estado').innerText = `Estado: ${data.estado}`;
      document.getElementById('distancia').innerText = `Distancia: ${data.distancia} cm`;
      document.getElementById('fecha').innerText = `Fecha y Hora: ${data.timestamp}`;
      document.getElementById('averageFillTime').innerText = `Promedio: ${data.averageFillTime || '--'} segundos`;

      if (data.alert) {
        document.getElementById('alerta').innerText = data.alert;
      }

      actualizarTacho(data.estado);
      registrarEstado(data.estado, data.timestamp);
      calcularPromedioLlenado();
      hacerPrediccionLlenado(data.estado, data.distancia);
      mostrarRecomendacion(data.averageFillTime);

      // Reproducir o detener audio si el estado es "Lleno"
      if (data.estado === 'Lleno' && !audioPlaying) {
                reproducirAudiosSecuenciales();
            } else if (data.estado !== 'Lleno' && audioPlaying) {
                detenerAudio();
            }
    };

    function actualizarTacho(estado) {
      const nivel = document.getElementById('nivel');
      let porcentaje = 0;
      switch (estado) {
        case 'Vacio':
          porcentaje = 0;
          break;
        case 'Bajo':
          porcentaje = 25;
          break;
        case 'Medio':
          porcentaje = 50;
          break;
        case 'Alto':
          porcentaje = 75;
          break;
        case 'Lleno':
          porcentaje = 100;
          break;
      }
      nivel.style.height = `${porcentaje}%`;
    }

    function registrarEstado(estado, timestamp) {
      if (estado !== estadoActual) {
        const finEstado = new Date();
        if (estadoActual !== '') {
          const duracion = (finEstado - inicioEstado) / 1000;
          const row = `<tr><td>${estadoActual}</td><td>${timestamp}</td><td>${duracion.toFixed(2)} s</td></tr>`;
          document.getElementById('estadoTable').innerHTML += row;
          tiemposEstados.push({ estado: estadoActual, duracion: duracion });
        }
        estadoActual = estado;
        inicioEstado = new Date();
      }
    }

    function calcularPromedioLlenado() {
      if (tiemposEstados.length === 0) return;

      const duraciones = tiemposEstados.filter(te => te.estado !== 'Vacio' && te.estado !== 'Lleno')
                                        .map(te => te.duracion);
      if (duraciones.length === 0) return;

      const promedio = duraciones.reduce((a, b) => a + b, 0) / duraciones.length;
      document.getElementById('averageFillTime').innerText = `Promedio: ${promedio.toFixed(2)} segundos`;
    }

    function hacerPrediccionLlenado(estado, distancia) {
      let mensaje = '';
      switch (estado) {
        case 'Vacio':
          mensaje = 'El tacho está vacío. Asegúrate de llenarlo pronto.';
          break;
        case 'Bajo':
          mensaje = 'El tacho está bajo. Requiere llenado pronto.';
          break;
        case 'Medio':
          mensaje = 'El tacho está medio lleno. Mantén el control.';
          break;
        case 'Alto':
          mensaje = 'El tacho está casi lleno. Revisa pronto.';
          break;
        case 'Lleno':
          mensaje = 'El tacho está lleno. Debe vaciarse.';
          break;
      }
      
      const tiempoLlenado = calcularTiempoLlenado(distancia);
      if (tiempoLlenado) {
        mensaje += ` Tiempo estimado para llenarse: ${tiempoLlenado} segundos.`;
      }

      document.getElementById('prediccionLlenado').innerText = mensaje;
    }

    function calcularTiempoLlenado(distancia) {
      const umbral = 3; // Distancia mínima para considerarlo lleno
      const tasaCambio = 5; // Ejemplo de tasa de cambio de nivel por segundo
      if (distancia < umbral) return 'Inminente'; // Relleno en curso
      return ((distancia - umbral) / tasaCambio).toFixed(2);
    }

    function mostrarRecomendacion(promedio) {
      const promedioNum = parseFloat(promedio);
      let mensaje = '';

      if (!isNaN(promedioNum)) {
        if (promedioNum < 10) {
          mensaje = getRandomRecommendation([
          'El tacho tiene un tiempo de llenado moderado, onichan. Ajusta tu planificación según sea necesario.',
'Onichan, el tiempo de llenado es aceptable. Considera realizar un monitoreo periódico.',
'El llenado es estable, onichan. Mantén el sistema bajo observación para evitar sorpresas.',
'Onichan, parece que el tacho se está llenando rápidamente. Planifica vaciados más frecuentes.',
'El tiempo de llenado es un poco corto, onichan. ¡Recuerda vigilarlo de cerca!',
'Onichan, el tacho se llena lentamente. Podrías aprovechar para revisar si todo está funcionando bien.',
'Tiempo de llenado prolongado, onichan. Quizás sea buena idea revisar el sistema.',
'Onichan, el tacho se llena en poco tiempo. Mantén la vigilancia constante y ajusta tus tiempos.',
'El tacho parece tener un llenado más lento de lo normal, onichan. Revisa si hay problemas en el proceso.',
'Onichan, ¡el tacho se llena con estabilidad! Mantén la observación periódica para asegurar un buen funcionamiento.'
          ]);
        } else if (promedioNum < 20) {
          mensaje = getRandomRecommendation([
          'El tacho tiene un tiempo de llenado moderado, onichan. Ajusta tu planificación según sea necesario.',
'Onichan, el tiempo de llenado es aceptable. Considera realizar un monitoreo periódico.',
'El llenado es estable, onichan. Mantén el sistema bajo observación para evitar sorpresas.',
'Onichan, parece que el tacho se está llenando rápidamente. Planifica vaciados más frecuentes.',
'El tiempo de llenado es un poco corto, onichan. ¡Recuerda vigilarlo de cerca!',
'Onichan, el tacho se llena lentamente. Podrías aprovechar para revisar si todo está funcionando bien.',
'Tiempo de llenado prolongado, onichan. Quizás sea buena idea revisar el sistema.',
'Onichan, el tacho se llena en poco tiempo. Mantén la vigilancia constante y ajusta tus tiempos.',
'El tacho parece tener un llenado más lento de lo normal, onichan. Revisa si hay problemas en el proceso.',
'Onichan, ¡el tacho se llena con estabilidad! Mantén la observación periódica para asegurar un buen funcionamiento.'
          ]);
        } else {
          mensaje = getRandomRecommendation([
          'El tacho tiene un tiempo de llenado moderado, onichan. Ajusta tu planificación según sea necesario.',
'Onichan, el tiempo de llenado es aceptable. Considera realizar un monitoreo periódico.',
'El llenado es estable, onichan. Mantén el sistema bajo observación para evitar sorpresas.',
'Onichan, parece que el tacho se está llenando rápidamente. Planifica vaciados más frecuentes.',
'El tiempo de llenado es un poco corto, onichan. ¡Recuerda vigilarlo de cerca!',
'Onichan, el tacho se llena lentamente. Podrías aprovechar para revisar si todo está funcionando bien.',
'Tiempo de llenado prolongado, onichan. Quizás sea buena idea revisar el sistema.',
'Onichan, el tacho se llena en poco tiempo. Mantén la vigilancia constante y ajusta tus tiempos.',
'El tacho parece tener un llenado más lento de lo normal, onichan. Revisa si hay problemas en el proceso.',
'Onichan, ¡el tacho se llena con estabilidad! Mantén la observación periódica para asegurar un buen funcionamiento.'
          ]);
        }
      } else {
        mensaje = 'No hay datos suficientes para proporcionar una recomendación.';
      }

      document.getElementById('mensajeRecomendacion').innerText = mensaje;
    }

    function getRandomRecommendation(recommendations) {
      const index = Math.floor(Math.random() * recommendations.length);
      return recommendations[index];
    }

    // Función para reproducir audios secuenciales mientras el estado es "Lleno"

function reproducirAudiosSecuenciales() {
    const audioPlayer = document.getElementById('audioPlayer');

    // Solo reproducir el audio si no está ya reproduciéndose
    if (!audioPlaying) {
        audioPlaying = true;
        audioContainer.classList.add('playing');
        audioContainer.classList.remove('stopped');
        audioPlayer.src = audios[audioIndex];
        audioPlayer.play();

        audioPlayer.onended = () => {
            // Cuando termina el audio, verificar si el estado sigue siendo 'Lleno'
            if (estadoActual === 'Lleno') {
                // Aumentar el índice o reiniciar si es el último audio
                audioIndex = (audioIndex + 1) % audios.length;
                audioPlayer.src = audios[audioIndex];
                audioPlayer.play();
            } else {
                detenerAudio(); // Detener si el estado cambia
            }
        };

        audioPlayer.onerror = () => {
            console.error("Error al reproducir el audio.");
            detenerAudio();
        };
    }
    document.addEventListener('click', () => {
    audioPlayer.play();
});

}

// Función para detener el audio si el estado cambia
function detenerAudio() {
    const audioPlayer = document.getElementById('audioPlayer');
    audioPlayer.pause();
    audioPlayer.currentTime = 0; // Reiniciar el tiempo del audio
    audioPlaying = false;
    audioContainer.classList.remove('playing');
    audioContainer.classList.add('stopped');
}

// Función que verifica el estado del sensor
function verificarEstadoDelSensor() {
    if (sensorDetectaLleno()) {
        if (estadoActual !== 'Lleno') {
            estadoActual = 'Lleno';
            reproducirAudiosSecuenciales(); // Reproduce el audio solo cuando cambia a "Lleno"
        }
    } else {
        if (estadoActual === 'Lleno') {
            estadoActual = 'Vacio'; // O cualquier otro estado que definas
            detenerAudio(); // Detener el audio si ya no está "Lleno"
        }
    }
}

// Simular función de detección del sensor
function sensorDetectaLleno() {
    // Aquí va tu lógica para detectar si el tacho está lleno
    // Deberías retornar true si el sensor detecta que está en el rango de lleno
    return Math.random() > 0.5; // Simulación (50% de probabilidad de estar lleno)
}



  </script>
</body>
</html>
