<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tacho Inteligente - Avanzado</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <h1>Monitoreo del Tacho</h1>
    <div class="tacho">
      <div id="nivel" class="nivel"></div>
    </div>
    <div class="info">
      <p id="estado">Estado: --</p>
      <p id="distancia">Distancia: -- cm</p>
      <p id="fecha">Fecha y Hora: --</p>
      <p id="alerta" class="alerta"></p>
    </div>
    <div class="analysis">
      <h2>Tiempo promedio de llenado</h2>
      <p id="averageFillTime">Promedio: -- segundos</p>
    </div>
    <h2>Duración de los estados</h2>
    <table>
      <thead>
        <tr>
          <th>Estado</th>
          <th>Fecha</th>
          <th>Duración</th>
        </tr>
      </thead>
      <tbody id="estadoTable"></tbody>
    </table>
  </div>

  <script>
    const ws = new WebSocket('ws://localhost:3000');
    let estadoActual = '';
    let inicioEstado;

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      document.getElementById('estado').innerText = `Estado: ${data.estado}`;
      document.getElementById('distancia').innerText = `Distancia: ${data.distancia} cm`;
      document.getElementById('fecha').innerText = `Fecha y Hora: ${data.timestamp}`;
      document.getElementById('averageFillTime').innerText = `Promedio: ${data.averageFillTime || '--'} segundos`;

      if (data.alert) {
        document.getElementById('alerta').innerText = data.alert;
      }

      actualizarTacho(data.estado);
      registrarEstado(data.estado, data.timestamp);
    };

    function actualizarTacho(estado) {
      const nivel = document.getElementById('nivel');
      let porcentaje = 0;
      switch (estado) {
        case 'Vacio':
          porcentaje = 0;
          break;
        case 'Bajo':
          porcentaje = 25;
          break;
        case 'Medio':
          porcentaje = 50;
          break;
        case 'Alto':
          porcentaje = 75;
          break;
        case 'Lleno':
          porcentaje = 100;
          break;
      }
      nivel.style.height = `${porcentaje}%`;
    }

    function registrarEstado(estado, timestamp) {
      if (estado !== estadoActual) {
        const finEstado = new Date();
        if (estadoActual !== '') {
          const duracion = (finEstado - inicioEstado) / 1000;
          const row = `<tr><td>${estadoActual}</td><td>${timestamp}</td><td>${duracion.toFixed(2)} s</td></tr>`;
          document.getElementById('estadoTable').innerHTML += row;
        }
        estadoActual = estado;
        inicioEstado = new Date();
      }
    }
  </script>
</body>
</html>
